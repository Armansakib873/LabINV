<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Inventory Tracker</title>
    
    <!-- LINK TO GOOGLE FONTS (Roboto) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- LINK TO FONT AWESOME FOR ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- LINK TO CHART.JS FOR CHARTS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- NEW PROFESSIONAL UI/DESIGN --- */
    
    /* 1. Root Variables & Global Styles */
    :root {
        --primary-color: #3B82F6; /* A modern, friendly blue */
        --primary-hover: #2563EB;
        --secondary-color: #E5E7EB; /* Light gray for backgrounds/borders */
        --background-color: #F9FAFB; /* Very light page background */
        --card-background: #FFFFFF;
        --text-dark: #1F2937;
        --text-light: #6B7280;
        --accent-green: #10B981;
        --accent-red: #EF4444;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --border-radius: 8px;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Roboto', sans-serif;
        background-color: var(--background-color);
        color: var(--text-dark);
        line-height: 1.6;
    }

    #app-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .hidden {
        display: none !important;
    }

    /* 2. Header & Navigation */
    header {
        background-color: var(--card-background);
        padding: 1.5rem 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    header h1 {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.75rem;
    }

    nav {
        display: flex;
        gap: 0.5rem;
    }

    .nav-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border: 1px solid transparent;
        background-color: transparent;
        color: var(--text-light);
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .nav-btn:hover {
        background-color: var(--background-color);
        color: var(--text-dark);
    }
    .nav-btn.active {
        background-color: var(--primary-color);
        color: var(--card-background);
    }
    .nav-btn i {
        font-size: 1rem;
    }

    /* 3. Main Content Cards */
    main {
        background-color: var(--card-background);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .view-header h2 {
        font-size: 1.5rem;
        font-weight: 500;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--text-dark);
    }

    /* 4. Forms & Controls */
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: flex-end;
    }

    label {
        display: block;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        color: var(--text-light);
    }

    input[type="text"],
    input[type="month"],
    select {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid var(--secondary-color);
        border-radius: 6px;
        background-color: var(--background-color);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background-color: var(--primary-color);
        color: var(--card-background);
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    button:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
    }
    button.edit-btn, button.edit-analyzer-btn { background-color: #F59E0B; }
    button.edit-btn:hover, button.edit-analyzer-btn:hover { background-color: #D97706; }
    button.delete-btn, button.delete-analyzer-btn { background-color: var(--accent-red); }
    button.delete-btn:hover, button.delete-analyzer-btn:hover { background-color: #DC2626; }
    
    #export-summary-btn { background-color: var(--accent-green); }
    #export-summary-btn:hover { background-color: #059669; }

    .settings-section { margin-top: 3rem; border-top: 1px solid var(--secondary-color); padding-top: 2rem; }
    .settings-section h3 { font-size: 1.25rem; margin-bottom: 1.5rem; font-weight: 500; }
    
    form { display: grid; grid-template-columns: 1fr 1fr auto; gap: 1.5rem; align-items: flex-end; }

    /* 5. Tables */
    .table-container { margin-top: 2rem; overflow-x: auto; }
    
    table {
        width: 100%;
        border-collapse: collapse;
        white-space: nowrap;
    }
    
    th, td {
        border: 1px solid var(--secondary-color);
        padding: 0.8rem 1rem;
        text-align: center;
    }

    thead th {
        background-color: var(--background-color);
        font-weight: 500;
        color: var(--text-light);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky; top: 0; z-index: 10;
    }

    tbody tr:nth-child(even) { background-color: var(--background-color); }
    .test-name-col, .sticky-col { font-weight: 500; text-align: left; }
    
    .sticky-col {
        position: sticky; left: 0;
        background-color: var(--card-background);
    }
    tbody tr:nth-child(even) .sticky-col {
        background-color: var(--background-color);
    }

    /* 6. Settings Items */
    .item-list-container { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
    .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border: 1px solid var(--secondary-color);
        border-radius: var(--border-radius);
    }
    .item span { font-weight: 500; }
    .item .actions { display: flex; gap: 0.75rem; }
    .item button { padding: 0.5rem 1rem; font-size: 0.9rem; }

    /* 7. Analysis View */
    #analysis-charts-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 3rem;
        margin-top: 2.5rem;
    }

    @media (min-width: 1024px) {
        #analysis-charts-container {
            grid-template-columns: 2fr 1fr; /* Make bar chart wider than pie chart */
        }
    }
</style>
</head>
<body>

    <div id="app-container">
        <!-- HEADER SECTION -->
        <header>
            <h1><i class="fas fa-vial"></i> Lab Inventory</h1>
            <nav>
                <button id="nav-inventory" class="nav-btn active"><i class="fas fa-calendar-day"></i> <span>Daily Entry</span></button>
                <button id="nav-summary" class="nav-btn"><i class="fas fa-chart-pie"></i> <span>Summary</span></button>
                <button id="nav-analysis" class="nav-btn"><i class="fas fa-chart-line"></i> <span>Data Analysis</span></button>
                <button id="nav-settings" class="nav-btn"><i class="fas fa-cog"></i> <span>Settings</span></button>
            </nav>
        </header>

        <!-- MAIN INVENTORY VIEW (DAILY DATA ENTRY) -->
        <main id="inventory-view">
            <div class="view-header">
                <h2>Daily Data Entry</h2>
                <div class="controls-grid">
                    <div>
                        <label for="inv-analyzer-filter">Analyzer</label>
                        <select id="inv-analyzer-filter"></select>
                    </div>
                    <div>
                        <label for="inv-month-filter">Month</label>
                        <input type="month" id="inv-month-filter">
                    </div>
                    <div>
                        <label for="inv-day-filter">Day</label>
                        <select id="inv-day-filter"></select>
                    </div>
                </div>
            </div>
            <div id="daily-data-container" class="table-container"></div>
        </main>
        
        <!-- MONTHLY SUMMARY VIEW -->
        <main id="summary-view" class="hidden">
            <div class="view-header">
                <h2>Monthly Summary</h2>
                <div class="controls-grid">
                     <div>
                        <label for="sum-analyzer-filter">Analyzer</label>
                        <select id="sum-analyzer-filter"></select>
                    </div>
                    <div>
                        <label for="sum-month-filter">Month</label>
                        <input type="month" id="sum-month-filter">
                    </div>
                    <button id="export-summary-btn"><i class="fas fa-file-excel"></i> <span>Export</span></button>
                </div>
            </div>
            <div id="summary-table-container" class="table-container"></div>
        </main>

        <!-- DATA ANALYSIS VIEW -->
        <main id="analysis-view" class="hidden">
            <div class="view-header">
                <h2>Data Analysis</h2>
                <div class="controls-grid">
                     <div>
                        <label for="an-analyzer-filter">Analyzer</label>
                        <select id="an-analyzer-filter"></select>
                    </div>
                    <div>
                        <label for="an-test-filter">Test</label>
                        <select id="an-test-filter"></select>
                    </div>
                </div>
            </div>
            <div id="analysis-charts-container">
                <div class="chart-wrapper">
                    <canvas id="monthly-consumption-chart"></canvas>
                </div>
                 <div class="chart-wrapper">
                    <canvas id="category-consumption-chart"></canvas>
                </div>
            </div>
        </main>

        <!-- SETTINGS VIEW -->
        <main id="settings-view" class="hidden">
            <div class="view-header"><h2>Settings</h2></div>
            
            <div class="settings-section">
                <h3>Manage Analyzers</h3>
                <form id="add-analyzer-form">
                    <div class="form-group">
                        <label for="analyzer-name-input">Analyzer Name</label>
                        <input type="text" id="analyzer-name-input" placeholder="e.g., Architect c4000" required>
                    </div>
                    <button type="submit"><i class="fas fa-plus"></i> <span>Add Analyzer</span></button>
                </form>
                <div id="existing-analyzers-container" class="item-list-container"></div>
            </div>
            
            <div class="settings-section">
                <h3>Manage Tests</h3>
                <form id="add-test-form">
                    <div class="form-group">
                        <label for="test-name-input">Test Name</label>
                        <input type="text" id="test-name-input" placeholder="e.g., Glucose" required>
                    </div>
                    <div class="form-group">
                        <label for="test-analyzer-select">Assign to Analyzer</label>
                        <select id="test-analyzer-select" required></select>
                    </div>
                    <button type="submit"><i class="fas fa-plus"></i> <span>Add Test</span></button>
                </form>
                <div id="existing-tests-container" class="item-list-container"></div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM ELEMENT REFERENCES ---
    const inventoryView = document.getElementById('inventory-view');
    const summaryView = document.getElementById('summary-view');
    const analysisView = document.getElementById('analysis-view');
    const settingsView = document.getElementById('settings-view');
    const navInventoryBtn = document.getElementById('nav-inventory');
    const navSummaryBtn = document.getElementById('nav-summary');
    const navAnalysisBtn = document.getElementById('nav-analysis');
    const navSettingsBtn = document.getElementById('nav-settings');
    const invAnalyzerFilter = document.getElementById('inv-analyzer-filter');
    const invMonthFilter = document.getElementById('inv-month-filter');
    const invDayFilter = document.getElementById('inv-day-filter');
    const dailyDataContainer = document.getElementById('daily-data-container');
    const sumAnalyzerFilter = document.getElementById('sum-analyzer-filter');
    const sumMonthFilter = document.getElementById('sum-month-filter');
    const summaryTableContainer = document.getElementById('summary-table-container');
    const exportSummaryBtn = document.getElementById('export-summary-btn');
    const addAnalyzerForm = document.getElementById('add-analyzer-form');
    const analyzerNameInput = document.getElementById('analyzer-name-input');
    const existingAnalyzersContainer = document.getElementById('existing-analyzers-container');
    const addTestForm = document.getElementById('add-test-form');
    const testNameInput = document.getElementById('test-name-input');
    const testAnalyzerSelect = document.getElementById('test-analyzer-select');
    const existingTestsContainer = document.getElementById('existing-tests-container');
    const anAnalyzerFilter = document.getElementById('an-analyzer-filter');
    const anTestFilter = document.getElementById('an-test-filter');
    const monthlyConsumptionChartCanvas = document.getElementById('monthly-consumption-chart').getContext('2d');
    const categoryConsumptionChartCanvas = document.getElementById('category-consumption-chart').getContext('2d');

    // --- APPLICATION STATE ---
    let appData = { analyzers: [], tests: [], inventoryData: {} };
    let monthlyConsumptionChart, categoryConsumptionChart;

    // --- DATA HANDLING ---
    const loadData = () => {
        const storedData = localStorage.getItem('labInventoryData');
        if (storedData) {
            const parsedData = JSON.parse(storedData);
            appData = {
                analyzers: Array.isArray(parsedData.analyzers) ? parsedData.analyzers : [],
                tests: Array.isArray(parsedData.tests) ? parsedData.tests : [],
                inventoryData: typeof parsedData.inventoryData === 'object' && parsedData.inventoryData !== null ? parsedData.inventoryData : {}
            };
        }
    };
    const saveData = () => localStorage.setItem('labInventoryData', JSON.stringify(appData));

    // --- INITIALIZATION ---
    const init = () => {
        loadData();
        setupEventListeners();
        setDefaultMonthAndDay();
        renderAll();
        switchView('inventory');
    };
    
    const setDefaultMonthAndDay = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString();
        const currentMonth = `${year}-${month}`;
        invMonthFilter.value = currentMonth;
        sumMonthFilter.value = currentMonth;
        populateDayFilter(currentMonth);
        invDayFilter.value = day;
    };

    // --- EVENT LISTENERS ---
    const setupEventListeners = () => {
        navInventoryBtn.addEventListener('click', () => switchView('inventory'));
        navSummaryBtn.addEventListener('click', () => switchView('summary'));
        navAnalysisBtn.addEventListener('click', () => switchView('analysis'));
        navSettingsBtn.addEventListener('click', () => switchView('settings'));
        invAnalyzerFilter.addEventListener('change', renderDailyEntryView);
        invMonthFilter.addEventListener('change', e => {
            populateDayFilter(e.target.value);
            renderDailyEntryView();
        });
        invDayFilter.addEventListener('change', renderDailyEntryView);
        sumAnalyzerFilter.addEventListener('change', renderSummaryTable);
        sumMonthFilter.addEventListener('change', renderSummaryTable);
        anAnalyzerFilter.addEventListener('change', () => {
            populateAnalysisTestFilter();
            renderAnalysisCharts();
        });
        anTestFilter.addEventListener('change', renderAnalysisCharts);
        dailyDataContainer.addEventListener('input', handleTableInput);
        exportSummaryBtn.addEventListener('click', exportSummaryToCSV);
        addAnalyzerForm.addEventListener('submit', handleAddAnalyzer);
        existingAnalyzersContainer.addEventListener('click', handleAnalyzerActions);
        addTestForm.addEventListener('submit', handleAddTest);
        existingTestsContainer.addEventListener('click', handleTestActions);
    };

    // --- VIEW SWITCHING & RENDERING ---
    const switchView = viewName => {
        [inventoryView, summaryView, analysisView, settingsView].forEach(v => v.classList.add('hidden'));
        [navInventoryBtn, navSummaryBtn, navAnalysisBtn, navSettingsBtn].forEach(b => b.classList.remove('active'));
        if (viewName === 'inventory') {
            inventoryView.classList.remove('hidden');
            navInventoryBtn.classList.add('active');
            renderDailyEntryView();
        } else if (viewName === 'summary') {
            summaryView.classList.remove('hidden');
            navSummaryBtn.classList.add('active');
            renderSummaryTable();
        } else if (viewName === 'analysis') {
            analysisView.classList.remove('hidden');
            navAnalysisBtn.classList.add('active');
            renderAnalysisView();
        } else if (viewName === 'settings') {
            settingsView.classList.remove('hidden');
            navSettingsBtn.classList.add('active');
            renderSettings();
        }
    };
    
    const renderAll = () => {
        renderAnalyzerFilters();
        renderSettings();
    };

    const populateDayFilter = selectedMonth => {
        const [year, month] = selectedMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        invDayFilter.innerHTML = Array.from({ length: daysInMonth }, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('');
    };

    const renderAnalyzerFilters = () => {
        const optionsHtml = appData.analyzers.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        invAnalyzerFilter.innerHTML = sumAnalyzerFilter.innerHTML = anAnalyzerFilter.innerHTML = optionsHtml;
        sumAnalyzerFilter.value = invAnalyzerFilter.value; // Sync filters initially
    };

    const renderSettings = () => {
        existingAnalyzersContainer.innerHTML = appData.analyzers.map(a => `<div class="item"><span>${a.name}</span><div class="actions"><button class="edit-analyzer-btn" data-id="${a.id}"><i class="fas fa-pencil-alt"></i></button><button class="delete-analyzer-btn" data-id="${a.id}"><i class="fas fa-trash"></i></button></div></div>`).join('');
        testAnalyzerSelect.innerHTML = appData.analyzers.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        existingTestsContainer.innerHTML = appData.tests.map(t => {
            const analyzer = appData.analyzers.find(a => a.id === t.analyzerId);
            return `<div class="item"><span><strong>${t.name}</strong> (${analyzer ? analyzer.name : 'N/A'})</span><div class="actions"><button class="edit-test-btn" data-id="${t.id}"><i class="fas fa-pencil-alt"></i></button><button class="delete-test-btn" data-id="${t.id}"><i class="fas fa-trash"></i></button></div></div>`;
        }).join('');
    };
    
    const renderDailyEntryView = () => {
        const analyzerId = parseInt(invAnalyzerFilter.value, 10), selectedMonth = invMonthFilter.value, selectedDay = invDayFilter.value;
        if (!analyzerId || !selectedMonth || !selectedDay) { dailyDataContainer.innerHTML = '<p>Please select an analyzer, month, and day.</p>'; return; }
        const tests = appData.tests.filter(t => t.analyzerId === analyzerId);
        if (tests.length === 0) { dailyDataContainer.innerHTML = '<p>No tests found for this analyzer. Add tests in Settings.</p>'; return; }
        const dateStr = `${selectedMonth}-${selectedDay.toString().padStart(2, '0')}`;
        const monthData = appData.inventoryData[selectedMonth] || {};
        const categories = ['QC', 'Cal', 'Repeat', 'Waste', 'Test'];
        let tableHTML = `<table class="single-day-table"><thead><tr><th class="test-name-col">Test Name</th><th>QC</th><th>Cal</th><th>Repeat</th><th>Waste</th><th>Test</th></tr></thead><tbody>`;
        tests.forEach(test => {
            const dayData = monthData[test.id]?.[dateStr] || {};
            tableHTML += `<tr><td class="test-name-col">${test.name}</td>`;
            categories.forEach(cat => {
                const type = cat.toLowerCase();
                tableHTML += `<td><input type="number" min="0" data-testid="${test.id}" data-date="${dateStr}" data-type="${type}" value="${dayData[type] || ''}"></td>`;
            });
            tableHTML += `</tr>`;
        });
        dailyDataContainer.innerHTML = tableHTML + `</tbody></table>`;
    };
    
    const renderSummaryTable = () => {
        const analyzerId = parseInt(sumAnalyzerFilter.value, 10), selectedMonth = sumMonthFilter.value;
        if (!analyzerId || !selectedMonth) { summaryTableContainer.innerHTML = '<p>Please select an analyzer and month.</p>'; return; }
        const summaryData = calculateSummary(analyzerId, selectedMonth);
        if(summaryData.length === 0) { summaryTableContainer.innerHTML = '<p>No tests or data found.</p>'; return; }
        const [year, month] = selectedMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        let tableHTML = `<table class="summary-table"><thead><tr>
            <th class="sticky-col">Test Name</th><th>Total Actual Test</th><th>Total Others</th><th>Final Total</th>`;
        for(let i=1; i <= daysInMonth; i++) { tableHTML += `<th>Day ${i}</th>`; }
        tableHTML += `</tr></thead><tbody>`;
        summaryData.forEach(row => {
            tableHTML += `<tr>
                <td class="sticky-col">${row.name}</td><td>${row.totalActualTest}</td>
                <td>${row.totalOthers}</td><td>${row.finalTotal}</td>`;
            row.dailyTotals.forEach(dayTotal => { tableHTML += `<td>${dayTotal > 0 ? dayTotal : ''}</td>`; });
            tableHTML += `</tr>`;
        });
        summaryTableContainer.innerHTML = tableHTML + `</tbody></table>`;
    };

    const renderAnalysisView = () => {
        populateAnalysisTestFilter();
        renderAnalysisCharts();
    };

    const populateAnalysisTestFilter = () => {
        const analyzerId = parseInt(anAnalyzerFilter.value, 10);
        const tests = appData.tests.filter(t => t.analyzerId === analyzerId);
        const optionsHtml = tests.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        anTestFilter.innerHTML = optionsHtml;
    };

    const renderAnalysisCharts = () => {
        const testId = parseInt(anTestFilter.value, 10);
        const test = appData.tests.find(t => t.id === testId);

        if (monthlyConsumptionChart) monthlyConsumptionChart.destroy();
        if (categoryConsumptionChart) categoryConsumptionChart.destroy();

        if (!test) {
            return;
        }

        const monthlyData = calculateMonthlyConsumption(testId);
        const categoryData = calculateCategoryConsumption(testId);

        monthlyConsumptionChart = new Chart(monthlyConsumptionChartCanvas, {
            type: 'bar',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Total Monthly Consumption',
                    data: monthlyData.data,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Total Tests' } }
                },
                plugins: {
                    title: { display: true, text: `Month-wise Consumption for ${test.name}`, font: { size: 16 } },
                    legend: { display: false }
                }
            }
        });

        categoryConsumptionChart = new Chart(categoryConsumptionChartCanvas, {
            type: 'pie',
            data: {
                labels: ['QC', 'Calibration', 'Repeats', 'Waste', 'Actual Tests'],
                datasets: [{
                    label: 'Consumption by Category',
                    data: Object.values(categoryData),
                    backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#6B7280', '#3B82F6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: `All-Time Breakdown for ${test.name}`, font: { size: 16 } },
                    legend: { position: 'top' }
                }
            }
        });
    };

    // --- DATA CALCULATION & HANDLING ---
    const handleTableInput = e => {
        if (e.target.tagName !== 'INPUT' || e.target.type !== 'number') return;
        const { testid, date, type } = e.target.dataset, value = e.target.value, month = date.substring(0, 7);
        if (!appData.inventoryData[month]) appData.inventoryData[month] = {};
        if (!appData.inventoryData[month][testid]) appData.inventoryData[month][testid] = {};
        if (!appData.inventoryData[month][testid][date]) appData.inventoryData[month][testid][date] = {};
        const numValue = parseInt(value, 10);
        if (!isNaN(numValue) && numValue >= 0) {
            appData.inventoryData[month][testid][date][type] = numValue;
        } else {
            delete appData.inventoryData[month][testid][date][type];
            if (Object.keys(appData.inventoryData[month][testid][date]).length === 0) delete appData.inventoryData[month][testid][date];
            if (Object.keys(appData.inventoryData[month][testid]).length === 0) delete appData.inventoryData[month][testid];
        }
        saveData();
    };

    const calculateSummary = (analyzerId, selectedMonth) => {
        const tests = appData.tests.filter(t => t.analyzerId === analyzerId);
        const monthData = appData.inventoryData[selectedMonth] || {};
        const [year, month] = selectedMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();

        return tests.map(test => {
            let totalActualTest = 0, totalOthers = 0;
            const dailyTotals = Array(daysInMonth).fill(0);
            const testMonthData = monthData[test.id] || {};
            for (const date in testMonthData) {
                const day = parseInt(date.split('-')[2], 10);
                const dayData = testMonthData[date];
                const daySum = (dayData.qc || 0) + (dayData.cal || 0) + (dayData.repeat || 0) + (dayData.waste || 0) + (dayData.test || 0);
                dailyTotals[day - 1] = daySum;
                totalActualTest += dayData.test || 0;
                totalOthers += (dayData.qc || 0) + (dayData.cal || 0) + (dayData.repeat || 0) + (dayData.waste || 0);
            }
            return { name: test.name, totalActualTest, totalOthers, finalTotal: totalActualTest + totalOthers, dailyTotals };
        });
    };

    const calculateMonthlyConsumption = testId => {
        const monthlyTotals = {};
        Object.keys(appData.inventoryData).forEach(month => {
            const testMonthData = appData.inventoryData[month][testId];
            if (testMonthData) {
                let total = 0;
                Object.values(testMonthData).forEach(dayData => {
                    total += Object.values(dayData).reduce((sum, val) => sum + (val || 0), 0);
                });
                monthlyTotals[month] = total;
            }
        });
        const sortedMonths = Object.keys(monthlyTotals).sort();
        const labels = sortedMonths.map(month => {
            const [year, monthNum] = month.split('-');
            return new Date(year, monthNum - 1).toLocaleString('default', { month: 'short', year: '2-digit' });
        });
        const data = sortedMonths.map(month => monthlyTotals[month]);
        return { labels, data };
    };

    const calculateCategoryConsumption = testId => {
        const categoryTotals = { qc: 0, cal: 0, repeat: 0, waste: 0, test: 0 };
        Object.values(appData.inventoryData).forEach(monthData => {
            const testMonthData = monthData[testId];
            if (testMonthData) {
                Object.values(testMonthData).forEach(dayData => {
                    categoryTotals.qc += dayData.qc || 0;
                    categoryTotals.cal += dayData.cal || 0;
                    categoryTotals.repeat += dayData.repeat || 0;
                    categoryTotals.waste += dayData.waste || 0;
                    categoryTotals.test += dayData.test || 0;
                });
            }
        });
        return categoryTotals;
    };

    // --- SETTINGS CRUD HANDLERS ---
    const handleAddAnalyzer = e => {
        e.preventDefault();
        const name = analyzerNameInput.value.trim();
        if (name && !appData.analyzers.some(a => a.name.toLowerCase() === name.toLowerCase())) {
            appData.analyzers.push({ id: Date.now(), name });
            saveData(); renderAll(); renderDailyEntryView(); analyzerNameInput.value = '';
        } else { alert('Analyzer name cannot be empty or already exist.'); }
    };
    
    const handleCRUD = (e, type) => {
        const target = e.target.closest('button');
        if (!target) return;
        const id = parseInt(target.dataset.id, 10);
        const isDelete = target.classList.contains(`delete-${type}-btn`);
        const isEdit = target.classList.contains(`edit-${type}-btn`);
        if (isEdit) {
            const item = appData[`${type}s`].find(i => i.id === id);
            const newName = prompt(`Enter new ${type} name:`, item.name);
            if (newName && newName.trim()) {
                item.name = newName.trim();
                saveData(); renderAll(); renderDailyEntryView();
            }
        }
        if (isDelete) {
            const warning = type === 'analyzer' ? 'WARNING: Deleting this analyzer will also delete ALL associated tests and their inventory data. Are you sure?' : 'Are you sure you want to delete this test and all its data?';
            if (confirm(warning)) {
                if (type === 'analyzer') {
                    const associatedTestIds = appData.tests.filter(t => t.analyzerId === id).map(t => t.id);
                    appData.tests = appData.tests.filter(t => t.analyzerId !== id);
                    for (const month in appData.inventoryData) {
                        associatedTestIds.forEach(testId => delete appData.inventoryData[month][testId]);
                    }
                }
                appData[`${type}s`] = appData[`${type}s`].filter(i => i.id !== id);
                if (type === 'test') {
                     for (const month in appData.inventoryData) delete appData.inventoryData[month][id];
                }
                saveData(); renderAll(); renderDailyEntryView();
            }
        }
    };
    const handleAnalyzerActions = e => handleCRUD(e, 'analyzer');
    const handleTestActions = e => handleCRUD(e, 'test');
    
    const handleAddTest = e => {
        e.preventDefault();
        const name = testNameInput.value.trim(), analyzerId = parseInt(testAnalyzerSelect.value, 10);
        if (name && analyzerId) {
            const comboExists = appData.tests.some(test => test.name.toLowerCase() === name.toLowerCase() && test.analyzerId === analyzerId);
            if(comboExists) {
                alert('This test name already exists for the selected analyzer.');
                return;
            }
            appData.tests.push({ id: Date.now(), name, analyzerId });
            saveData(); renderSettings(); addTestForm.reset();
        } else { alert('Please provide a test name and select an analyzer.'); }
    };

    // --- EXPORT FUNCTIONALITY ---
    const exportSummaryToCSV = () => {
        const analyzerId = parseInt(sumAnalyzerFilter.value, 10), selectedMonth = sumMonthFilter.value;
        if (!analyzerId || !selectedMonth) { alert('Please select an analyzer and month to export.'); return; }
        
        const [year, monthNum] = selectedMonth.split('-'), daysInMonth = new Date(year, monthNum, 0).getDate();
        const dateForMonthName = new Date(year, monthNum - 1, 1), monthName = dateForMonthName.toLocaleString('default', { month: 'long' });
        const summaryData = calculateSummary(analyzerId, selectedMonth);

        let header = "Test Name,Total Actual Test,Total Others,Final Total";
        for(let i=1; i <= daysInMonth; i++) { header += `,Day ${i}`; }
        
        let csvContent = header + "\n";
        summaryData.forEach(row => {
            let csvRow = `"${row.name}",${row.totalActualTest},${row.totalOthers},${row.finalTotal}`;
            csvRow += "," + row.dailyTotals.join(',');
            csvContent += csvRow + "\n";
        });
        
        const analyzer = appData.analyzers.find(a => a.id === analyzerId);
        const fileName = `Inventory_Summary_${analyzer.name}_${monthName}-${year}.csv`;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // --- START THE APPLICATION ---
    init();
});
</script>
</body>
</html>